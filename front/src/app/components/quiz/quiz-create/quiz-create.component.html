<div class="container py-4">
    <div class="card">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h2 class="mb-0">
                <i class="bi bi-question-square me-2"></i>
                {{ isEditMode ? 'Редактирование квиза' : 'Создание квиза' }}
            </h2>
        </div>

        <div *ngIf="isLoading" class="card-body text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Загрузка...</span>
            </div>
            <p class="mt-3">Загрузка данных квиза...</p>
        </div>

        <div *ngIf="error" class="card-body">
            <div class="alert alert-danger">
                {{ error }}
            </div>
        </div>

        <div *ngIf="!isLoading" class="card-body">
            <form [formGroup]="quizForm" (ngSubmit)="onSubmit()">
                <!-- Основные данные квиза -->
                <div class="mb-4">
                    <div class="mb-3">
                        <label for="description" class="form-label">Описание квиза</label>
                        <textarea id="description" class="form-control" formControlName="description"
                            rows="3"></textarea>
                        <div *ngIf="quizForm.get('description')?.invalid && quizForm.get('description')?.touched"
                            class="text-danger mt-1">
                            <div *ngIf="quizForm.get('description')?.errors?.['required']">Описание обязательно</div>
                            <div *ngIf="quizForm.get('description')?.errors?.['minlength']">
                                Описание должно содержать не менее 5 символов
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="timeToPass" class="form-label">Время на прохождение (в минутах)</label>
                        <input type="number" id="timeToPass" class="form-control" formControlName="timeToPass" min="1"
                            max="120">
                        <div *ngIf="quizForm.get('timeToPass')?.invalid && quizForm.get('timeToPass')?.touched"
                            class="text-danger mt-1">
                            <div *ngIf="quizForm.get('timeToPass')?.errors?.['required']">Время прохождения обязательно
                            </div>
                            <div *ngIf="quizForm.get('timeToPass')?.errors?.['min']">
                                Время должно быть не менее 1 минуты
                            </div>
                            <div *ngIf="quizForm.get('timeToPass')?.errors?.['max']">
                                Время не должно превышать 120 минут
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Вопросы -->
                <h4 class="mb-3">Вопросы</h4>
                <div formArrayName="questions">
                    <div *ngFor="let questionGroup of questions.controls; let i = index" [formGroupName]="i"
                        class="card mb-4">
                        <div class="card-header bg-light d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Вопрос {{ i + 1 }}</h5>
                            <button type="button" class="btn btn-outline-danger btn-sm" (click)="removeQuestion(i)">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label [for]="'question-' + i" class="form-label">Текст вопроса</label>
                                <textarea [id]="'question-' + i" class="form-control" formControlName="text"
                                    rows="2"></textarea>
                                <div *ngIf="questionGroup.get('text')?.invalid && questionGroup.get('text')?.touched"
                                    class="text-danger mt-1">
                                    Текст вопроса обязателен
                                </div>
                            </div>

                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label [for]="'question-type-' + i" class="form-label">Тип вопроса</label>
                                    <select [id]="'question-type-' + i" class="form-select" formControlName="type"
                                        (change)="onTypeChange(i)">
                                        <option *ngFor="let type of questionTypes" [value]="type.value">
                                            {{ type.label }}
                                        </option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label [for]="'question-points-' + i" class="form-label">Баллы за вопрос</label>
                                    <input type="number" [id]="'question-points-' + i" class="form-control"
                                        formControlName="points" min="1">
                                    <div *ngIf="questionGroup.get('points')?.invalid && questionGroup.get('points')?.touched"
                                        class="text-danger mt-1">
                                        <div *ngIf="questionGroup.get('points')?.errors?.['required']">Баллы обязательны
                                        </div>
                                        <div *ngIf="questionGroup.get('points')?.errors?.['min']">
                                            Минимальное значение - 1
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Варианты ответов -->
                            <div *ngIf="questionGroup.get('type')?.value !== QuestionType.TEXT_ANSWER">
                                <div class="mb-3 d-flex justify-content-between align-items-center">
                                    <label class="form-label">Варианты ответов</label>
                                    <button type="button" class="btn btn-sm btn-outline-primary" (click)="addAnswer(i)">
                                        <i class="bi bi-plus-circle me-1"></i>
                                        Добавить ответ
                                    </button>
                                </div>

                                <div formArrayName="answers">
                                    <div *ngFor="let answerGroup of getQuestionAnswers(i).controls; let j = index"
                                        [formGroupName]="j" class="card mb-2">
                                        <div class="card-body py-2">
                                            <div class="row align-items-center">
                                                <div class="col-1">
                                                    <div class="form-check">
                                                        <input type="checkbox" class="form-check-input"
                                                            [id]="'answer-correct-' + i + '-' + j"
                                                            formControlName="isCorrect">
                                                        <label [for]="'answer-correct-' + i + '-' + j"></label>
                                                    </div>
                                                </div>
                                                <div class="col-10">
                                                    <input type="text" class="form-control"
                                                        [id]="'answer-' + i + '-' + j" formControlName="text"
                                                        placeholder="Вариант ответа">
                                                    <div *ngIf="answerGroup.get('text')?.invalid && answerGroup.get('text')?.touched"
                                                        class="text-danger mt-1">
                                                        Текст ответа обязателен
                                                    </div>
                                                </div>
                                                <div class="col-1 text-end">
                                                    <button type="button" class="btn btn-sm btn-outline-danger"
                                                        (click)="removeAnswer(i, j)">
                                                        <i class="bi bi-trash"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Для текстовых вопросов -->
                            <div *ngIf="questionGroup.get('type')?.value === QuestionType.TEXT_ANSWER">
                                <div class="alert alert-info">
                                    <i class="bi bi-info-circle me-2"></i>
                                    Для текстового вопроса пользователь должен будет ввести ответ в текстовое поле.
                                </div>

                                <div formArrayName="answers" *ngIf="getQuestionAnswers(i).controls.length > 0">
                                    <div [formGroupName]="0" class="mb-3">
                                        <label [for]="'answer-text-' + i" class="form-label">Правильный ответ</label>
                                        <input type="text" class="form-control" [id]="'answer-text-' + i"
                                            formControlName="text">
                                        <div *ngIf="getQuestionAnswers(i).at(0).get('text')?.invalid && getQuestionAnswers(i).at(0).get('text')?.touched"
                                            class="text-danger mt-1">
                                            Правильный ответ обязателен
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Кнопка добавления вопроса -->
                <button type="button" class="btn btn-outline-primary mb-4" (click)="addQuestion()">
                    <i class="bi bi-plus-circle me-2"></i>
                    Добавить вопрос
                </button>

                <!-- Кнопки формы -->
                <div class="d-flex justify-content-between">
                    <button type="button" class="btn btn-secondary" (click)="cancel()">
                        <i class="bi bi-x-circle me-2"></i>
                        Отмена
                    </button>
                    <button type="submit" class="btn btn-primary" [disabled]="isSaving">
                        <span *ngIf="isSaving" class="spinner-border spinner-border-sm me-2" role="status"></span>
                        <i *ngIf="!isSaving" class="bi bi-check-circle me-2"></i>
                        {{ isEditMode ? 'Сохранить изменения' : 'Создать квиз' }}
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>